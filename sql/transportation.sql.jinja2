SELECT
    ST_AsMVTGeom((ST_Dump(ST_LineMerge(ST_Collect(way)))).geom, {{bbox}}, {{extent}}) AS way,
    highway,
    NULL AS railway
  FROM planet_osm_roads
  WHERE way && {{bbox}}
{% if zoom <= 6 %}
    AND highway IN ('motorway', 'trunk')
{% elif zoom <= 8 %}
    AND highway IN ('motorway', 'trunk', 'primary')
{% else %}
    AND highway IN ('motorway', 'trunk', 'primary', 'secondary')
{% endif %}
  GROUP BY highway, railway
{% if zoom >= 7 %}
UNION ALL
SELECT
    ST_AsMVTGeom((ST_Dump(ST_LineMerge(ST_Collect(way)))).geom, {{bbox}}, {{extent}}) AS way,
    NULL AS highway,
    railway
  FROM planet_osm_roads
  WHERE way && {{bbox}}
    AND railway IS NOT NULL
    AND railway != 'preserved'
    AND (service IS NULL OR service NOT IN ('spur', 'siding', 'yard'))
  GROUP BY highway, railway
{% endif %}
